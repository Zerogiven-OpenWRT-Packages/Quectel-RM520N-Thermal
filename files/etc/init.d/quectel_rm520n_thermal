#!/bin/sh /etc/rc.common
# OpenWrt initialization script for the quectel_rm520n_temp_daemon with support for dynamic Device Tree (DT) overlays.
# To use this script, place it in /etc/init.d/quectel_rm520n_temp_daemon and make it executable with "chmod +x /etc/init.d/quectel_rm520n_temp_daemon".
# Enable the service with: /etc/init.d/quectel_rm520n_temp_daemon enable

# shellcheck disable=SC2034
USE_PROCD=1
START=50
STOP=50
SERVICE_PROVIDES="quectel_rm520n_temp_daemon"

# Configuration for the Device Tree overlay (adjust the path if necessary)
OVERLAY_FILE="/lib/firmware/quectel_rm520n_temp/quectel_rm520n_temp_sensor.dtbo"
OVERLAY_NAME="quectel_rm520n_temp_sensor"

# Function to load the Device Tree overlay
load_overlay() {
    if [ ! -f ${OVERLAY_FILE} ]; then
        logger "Device Tree overlay file ${OVERLAY_FILE} not found."
        return 1
    fi
    if [ -d /sys/kernel/config/device-tree/overlays ]; then
        mkdir -p /sys/kernel/config/device-tree/overlays/${OVERLAY_NAME}
        if cat ${OVERLAY_FILE} >/sys/kernel/config/device-tree/overlays/${OVERLAY_NAME}/dtbo; then
            logger "Device Tree overlay ${OVERLAY_NAME} loaded successfully."
        else
            logger "Failed to load Device Tree overlay ${OVERLAY_NAME}."
        fi
    else
        logger "Dynamic Device Tree overlays are not supported on this board."
    fi
}

# Function to remove the Device Tree overlay
remove_overlay() {
    if [ -d /sys/kernel/config/device-tree/overlays/${OVERLAY_NAME} ]; then
        rmdir /sys/kernel/config/device-tree/overlays/${OVERLAY_NAME}
        logger "Device Tree overlay ${OVERLAY_NAME} removed."
    fi
}

# Function to start the service
start_service() {
    load_overlay
    procd_open_instance
    procd_set_param command /usr/bin/quectel_rm520n_temp_daemon
    procd_set_param respawn 5 5 0
    procd_close_instance
}

# Function to stop the service
stop_service() {
    remove_overlay
    return 0
}
